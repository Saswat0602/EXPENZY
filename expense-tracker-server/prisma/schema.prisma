generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Currency {
  INR // Indian Rupee
  USD // US Dollar
  EUR // Euro
}

enum CategoryType {
  EXPENSE
  INCOME
  GROUP
}

enum UserAvatarStyle {
  adventurer
  adventurer_neutral
  thumbs
  fun_emoji
}

enum GroupIconProvider {
  jdenticon
}

model User {
  id                    String              @id @default(uuid())
  email                 String              @unique
  username              String              @unique
  passwordHash          String?             @map("password_hash")
  phone                 String?
  defaultCurrency       Currency            @default(INR) @map("default_currency")
  timezone              String              @default("UTC")
  profilePictureUrl     String?             @map("profile_picture_url")
  isActive              Boolean             @default(true) @map("is_active")
  isVerified            Boolean             @default(false) @map("is_verified")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  lastLoginAt           DateTime?           @map("last_login_at")
  isDeleted             Boolean             @default(false) @map("is_deleted")
  deletedAt             DateTime?           @map("deleted_at")
  avatar                String?
  avatarSeed            String?             @map("avatar_seed")
  avatarStyle           UserAvatarStyle?    @default(adventurer) @map("avatar_style")
  avatarUrl             String?             @map("avatar_url")
  firstName             String?             @map("first_name")
  googleId              String?             @unique
  lastName              String?             @map("last_name")
  monthlyIncomeTarget   Decimal?            @map("monthly_income_target") @db.Decimal(15, 2)
  monthlyExpenseTarget  Decimal?            @map("monthly_expense_target") @db.Decimal(15, 2)
  onboardingCompleted   Boolean             @default(false) @map("onboarding_completed")
  twoFactorEnabled      Boolean             @default(false) @map("two_factor_enabled")
  lastPasswordChange    DateTime?           @map("last_password_change")
  budgets               Budget[]
  categories            Category[]
  expenses              Expense[]
  loansBorrowed         Loan[]              @relation("Borrower")
  loansLent             Loan[]              @relation("Lender")
  notifications         Notification[]
  recurringPatterns     RecurringPattern[]
  splitExpensesPaid     SplitExpense[]      @relation("PaidBy")
  splitParticipations   SplitParticipant[]  @relation("SplitParticipations")
  groupsCreated         Group[]             @relation("GroupCreator")
  groupMemberships      GroupMember[]       @relation("GroupMemberships")
  incomes               Income[]
  savingsGoals          SavingsGoal[]
  settings              UserSettings?
  groupExpensesPaid     GroupExpense[]      @relation("GroupExpensePaidBy")
  groupExpensesModified GroupExpense[]      @relation("ExpenseLastModifier")
  groupExpenseSplits    GroupExpenseSplit[] @relation("GroupExpenseSplitUser")
  settlementsFrom       Settlement[]        @relation("SettlementFrom")
  settlementsTo         Settlement[]        @relation("SettlementTo")
  loanAdjustments       LoanAdjustment[]    @relation("LoanAdjustmentCreator")
  contacts              UserContact[]       @relation("UserContacts")
  contactedBy           UserContact[]       @relation("ContactedBy")
  splitExpenses         SplitExpense[]
  otps                  Otp[]

  @@index([email])
  @@index([googleId])
  @@index([isActive, isDeleted])
  @@index([createdAt])
  @@index([lastLoginAt])
  @@map("users")
}

model Category {
  id               String         @id @default(uuid())
  userId           String?        @map("user_id")
  name             String
  icon             String?
  color            String?
  type             CategoryType
  isSystem         Boolean        @default(false) @map("is_system")
  parentCategoryId String?        @map("parent_category_id")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  budgets          Budget[]
  parentCategory   Category?      @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  subCategories    Category[]     @relation("CategoryHierarchy")
  user             User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenses         Expense[]
  incomes          Income[]
  groupExpenses    GroupExpense[]

  @@unique([userId, name, type])
  @@index([userId, type])
  @@index([isSystem])
  @@index([type])
  @@index([parentCategoryId])
  @@index([userId, isSystem])
  @@map("categories")
}

model Expense {
  id                   String            @id @default(uuid())
  userId               String            @map("user_id")
  categoryId           String?           @map("category_id")
  amount               Decimal           @db.Decimal(15, 2)
  currency             Currency          @default(INR)
  originalAmount       Decimal?          @map("original_amount") @db.Decimal(15, 2)
  originalCurrency     String?           @map("original_currency")
  exchangeRate         Decimal?          @map("exchange_rate") @db.Decimal(10, 4)
  description          String?
  expenseDate          DateTime          @map("expense_date") @db.Date
  paymentMethod        String?           @map("payment_method")
  isRecurring          Boolean           @default(false) @map("is_recurring")
  recurringPatternId   String?           @map("recurring_pattern_id")
  receiptUrl           String?           @map("receipt_url")
  notes                String?
  locationLat          Decimal?          @map("location_lat") @db.Decimal(10, 8)
  locationLng          Decimal?          @map("location_lng") @db.Decimal(11, 8)
  locationName         String?           @map("location_name")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  deletedAt            DateTime?         @map("deleted_at")
  autoDetectedCategory Boolean           @default(false) @map("auto_detected_category")
  categoryConfidence   Float?            @map("category_confidence")
  categorySource       String?           @map("category_source")
  category             Category?         @relation(fields: [categoryId], references: [id])
  recurringPattern     RecurringPattern? @relation(fields: [recurringPatternId], references: [id])
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  splitExpense         SplitExpense[]

  @@index([userId, expenseDate(sort: Desc)])
  @@index([categoryId])
  @@index([userId, deletedAt])
  @@index([expenseDate])
  @@index([userId, categoryId, expenseDate])
  @@index([userId, isRecurring])
  @@index([recurringPatternId])
  @@index([userId, currency])
  @@index([paymentMethod])
  @@index([userId, createdAt(sort: Desc)])
  @@map("expenses")
}

model RecurringPattern {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  frequency      String
  interval       Int       @default(1)
  dayOfWeek      Int?      @map("day_of_week")
  dayOfMonth     Int?      @map("day_of_month")
  startDate      DateTime  @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  nextOccurrence DateTime  @map("next_occurrence") @db.Date
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  expenses       Expense[]
  incomes        Income[]
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([nextOccurrence, isActive])
  @@index([frequency])
  @@index([userId, frequency, isActive])
  @@map("recurring_patterns")
}

model SplitExpense {
  id           String             @id @default(uuid())
  expenseId    String             @map("expense_id")
  groupId      String?            @map("group_id")
  totalAmount  Decimal            @map("total_amount") @db.Decimal(15, 2)
  currency     String             @default("USD")
  splitType    String             @map("split_type")
  paidByUserId String             @map("paid_by_user_id")
  description  String?
  isSettled    Boolean            @default(false) @map("is_settled")
  settledAt    DateTime?          @map("settled_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  expense      Expense            @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  group        Group?             @relation("GroupSplits", fields: [groupId], references: [id])
  paidByUser   User               @relation("PaidBy", fields: [paidByUserId], references: [id])
  participants SplitParticipant[]
  user         User?              @relation(fields: [userId], references: [id])
  userId       String?

  @@index([paidByUserId])
  @@index([isSettled])
  @@index([expenseId])
  @@index([groupId])
  @@index([paidByUserId, isSettled])
  @@index([groupId, isSettled])
  @@index([createdAt(sort: Desc)])
  @@map("split_expenses")
}

model SplitParticipant {
  id             String       @id @default(uuid())
  splitExpenseId String       @map("split_expense_id")
  userId         String       @map("user_id")
  amountOwed     Decimal      @map("amount_owed") @db.Decimal(15, 2)
  amountPaid     Decimal      @default(0) @map("amount_paid") @db.Decimal(15, 2)
  percentage     Decimal?     @db.Decimal(5, 2)
  shares         Int?
  isSettled      Boolean      @default(false) @map("is_settled")
  settledAt      DateTime?    @map("settled_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  splitExpense   SplitExpense @relation(fields: [splitExpenseId], references: [id], onDelete: Cascade)
  user           User         @relation("SplitParticipations", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([splitExpenseId, userId])
  @@index([userId, isSettled])
  @@index([splitExpenseId])
  @@index([userId])
  @@map("split_participants")
}

model Loan {
  id              String    @id @default(uuid())
  lenderUserId    String    @map("lender_user_id")
  borrowerUserId  String    @map("borrower_user_id")
  amount          Decimal   @db.Decimal(15, 2)
  currency        String    @default("USD")
  interestRate    Decimal?  @default(0) @map("interest_rate") @db.Decimal(5, 2)
  description     String?
  loanDate        DateTime  @map("loan_date") @db.Date
  dueDate         DateTime? @map("due_date") @db.Date
  status          String    @default("active")
  amountPaid      Decimal   @default(0) @map("amount_paid") @db.Decimal(15, 2)
  amountRemaining Decimal   @map("amount_remaining") @db.Decimal(15, 2)
  paymentTerms    String?   @map("payment_terms")

  // Group integration
  groupId    String? @map("group_id")
  sourceType String  @default("direct") @map("source_type") // 'direct', 'group_balance', 'settlement'
  sourceId   String? @map("source_id") // ID of source entity

  // Enhanced payment tracking
  lastPaymentDate DateTime? @map("last_payment_date")

  // Soft delete
  isDeleted Boolean   @default(false) @map("is_deleted")
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  adjustments LoanAdjustment[]
  settlements Settlement[]
  group       Group?           @relation(fields: [groupId], references: [id], onDelete: SetNull)
  borrower    User             @relation("Borrower", fields: [borrowerUserId], references: [id])
  lender      User             @relation("Lender", fields: [lenderUserId], references: [id])

  @@index([lenderUserId, status])
  @@index([borrowerUserId, status])
  @@index([dueDate])
  @@index([status])
  @@index([lenderUserId, dueDate])
  @@index([borrowerUserId, dueDate])
  @@index([loanDate])
  @@index([groupId])
  @@index([sourceType])
  @@index([lenderUserId, isDeleted])
  @@index([borrowerUserId, isDeleted])
  @@map("loans")
}

model LoanAdjustment {
  id             String    @id @default(uuid())
  loanId         String    @map("loan_id")
  adjustmentType String    @map("adjustment_type") // 'payment', 'increase', 'decrease', 'waive'
  amount         Decimal   @db.Decimal(15, 2)
  currency       String    @default("INR")
  reason         String?
  notes          String?
  paymentMethod  String?   @map("payment_method") // For payment type adjustments
  paymentDate    DateTime? @map("payment_date") @db.Date // For payment type adjustments
  createdBy      String    @map("created_by")
  createdAt      DateTime  @default(now()) @map("created_at")

  loan    Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  creator User @relation("LoanAdjustmentCreator", fields: [createdBy], references: [id])

  @@index([loanId, createdAt(sort: Desc)])
  @@index([adjustmentType])
  @@index([createdBy])
  @@map("loan_adjustments")
}

// ============================================
// USER CONTACTS MODEL
// ============================================

model UserContact {
  id     String @id @default(uuid())
  userId String @map("user_id") // Owner of this contact

  // For external contacts (not registered users)
  contactName  String? @map("contact_name")
  contactEmail String? @map("contact_email")
  contactPhone String? @map("contact_phone")

  // For registered users
  contactUserId String? @map("contact_user_id") // Reference to User

  // Privacy control
  isVerified Boolean @default(false) @map("is_verified") // Did contact accept?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user         User          @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  contactUser  User?         @relation("ContactedBy", fields: [contactUserId], references: [id], onDelete: Cascade)
  groupMembers GroupMember[]

  @@unique([userId, contactUserId]) // Can't have duplicate registered contacts
  @@unique([userId, contactEmail]) // Can't have duplicate email contacts
  @@index([userId])
  @@index([contactUserId])
  @@map("user_contacts")
}

model Budget {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  categoryId       String?   @map("category_id")
  amount           Decimal   @db.Decimal(15, 2)
  currency         String    @default("USD")
  periodType       String    @map("period_type")
  startDate        DateTime  @map("start_date") @db.Date
  endDate          DateTime  @map("end_date") @db.Date
  spentAmount      Decimal   @default(0) @map("spent_amount") @db.Decimal(15, 2)
  alertThreshold   Decimal?  @map("alert_threshold") @db.Decimal(5, 2)
  allowRollover    Boolean   @default(false) @map("allow_rollover")
  rolledOverAmount Decimal   @default(0) @map("rolled_over_amount") @db.Decimal(15, 2)
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  category         Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([categoryId])
  @@index([userId, periodType, isActive])
  @@index([startDate, endDate])
  @@index([userId, startDate, endDate])
  @@map("budgets")
}

model Notification {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  type              String
  title             String
  message           String
  relatedEntityType String?   @map("related_entity_type")
  relatedEntityId   String?   @map("related_entity_id")
  priority          String    @default("normal")
  actionUrl         String?   @map("action_url")
  actionLabel       String?   @map("action_label")
  imageUrl          String?   @map("image_url")
  expiresAt         DateTime? @map("expires_at")
  category          String?
  isRead            Boolean   @default(false) @map("is_read")
  readAt            DateTime? @map("read_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type])
  @@index([relatedEntityType, relatedEntityId])
  @@index([userId, priority, isRead])
  @@map("notifications")
}

model Group {
  id           String             @id @default(uuid())
  name         String
  description  String?
  imageUrl     String?            @map("image_url")
  iconSeed     String?            @map("icon_seed")
  iconProvider GroupIconProvider? @default(jdenticon) @map("icon_provider")
  iconUrl      String?            @map("icon_url")

  // Group type/category
  groupType String @default("other") @map("group_type")

  // Default currency for the group
  currency Currency @default(INR)

  // Simplify debts (minimize transactions)
  simplifyDebts Boolean @default(true) @map("simplify_debts")

  // Allow non-member expenses
  allowNonMembers Boolean @default(false) @map("allow_non_members")

  // Group icon/emoji
  icon String? @default("friends")

  // Group color theme
  color String? @default("purple")

  createdByUserId String  @map("created_by_user_id")
  createdBy       User    @relation("GroupCreator", fields: [createdByUserId], references: [id])
  isActive        Boolean @default(true) @map("is_active")

  // Archive instead of delete
  isArchived Boolean   @default(false) @map("is_archived")
  archivedAt DateTime? @map("archived_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members       GroupMember[]
  splitExpenses SplitExpense[] @relation("GroupSplits")
  groupExpenses GroupExpense[]
  settlements   Settlement[]
  loans         Loan[]

  @@index([createdByUserId])
  @@index([isActive])
  @@index([isArchived])
  @@index([groupType])
  @@index([currency])
  @@index([createdAt(sort: Desc)])
  @@index([createdByUserId, isActive])
  @@map("groups")
}

model GroupMember {
  id           String       @id @default(uuid())
  groupId      String       @map("group_id")
  group        Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId       String?      @map("user_id")
  user         User?        @relation("GroupMemberships", fields: [userId], references: [id])
  contactId    String?      @map("contact_id") // Link to UserContact for non-registered members
  contact      UserContact? @relation(fields: [contactId], references: [id])
  role         String       @default("member")
  inviteToken  String?      @unique @map("invite_token")
  inviteStatus String?      @default("pending") @map("invite_status")
  invitedEmail String?      @map("invited_email") // Email of invited user (for pending invites)
  joinedAt     DateTime?    @map("joined_at")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([contactId])
  @@index([inviteStatus])
  @@index([groupId, inviteStatus])
  @@index([groupId, role])
  @@index([inviteToken])
  @@index([groupId, userId, inviteStatus]) // Composite index for membership checks
  @@index([userId, inviteStatus]) // For user's group list
  @@map("group_members")
}

// ============================================
// INCOME TRACKING MODELS
// ============================================

model Income {
  id                 String    @id @default(uuid())
  userId             String    @map("user_id")
  categoryId         String?   @map("category_id")
  amount             Decimal   @db.Decimal(15, 2)
  currency           String    @default("USD")
  source             String
  description        String?
  incomeDate         DateTime  @map("income_date") @db.Date
  isRecurring        Boolean   @default(false) @map("is_recurring")
  recurringPatternId String?   @map("recurring_pattern_id")
  paymentMethod      String?   @map("payment_method")
  notes              String?
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  category         Category?         @relation(fields: [categoryId], references: [id])
  recurringPattern RecurringPattern? @relation(fields: [recurringPatternId], references: [id])

  @@index([userId, incomeDate(sort: Desc)])
  @@index([categoryId])
  @@index([userId, deletedAt])
  @@index([userId, source])
  @@index([userId, isRecurring])
  @@index([recurringPatternId])
  @@index([userId, categoryId])
  @@index([incomeDate])
  @@map("incomes")
}

// ============================================
// SAVINGS GOALS MODELS
// ============================================

model SavingsGoal {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  name          String
  description   String?
  targetAmount  Decimal   @map("target_amount") @db.Decimal(15, 2)
  currentAmount Decimal   @default(0) @map("current_amount") @db.Decimal(15, 2)
  currency      String    @default("USD")
  targetDate    DateTime? @map("target_date") @db.Date
  priority      String    @default("medium")
  icon          String?
  color         String?
  isCompleted   Boolean   @default(false) @map("is_completed")
  completedAt   DateTime? @map("completed_at")
  isArchived    Boolean   @default(false) @map("is_archived")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions SavingsContribution[]

  @@index([userId, isCompleted, isArchived])
  @@index([userId, targetDate])
  @@index([userId, priority])
  @@index([userId, createdAt(sort: Desc)])
  @@index([isCompleted, isArchived])
  @@map("savings_goals")
}

model SavingsContribution {
  id               String   @id @default(uuid())
  savingsGoalId    String   @map("savings_goal_id")
  amount           Decimal  @db.Decimal(15, 2)
  currency         String   @default("USD")
  contributionDate DateTime @map("contribution_date") @db.Date
  notes            String?
  createdAt        DateTime @default(now()) @map("created_at")

  savingsGoal SavingsGoal @relation(fields: [savingsGoalId], references: [id], onDelete: Cascade)

  @@index([savingsGoalId, contributionDate(sort: Desc)])
  @@map("savings_contributions")
}

// ============================================
// SUBSCRIPTION TRACKING MODEL
// ============================================

// ============================================
// PAYMENT METHODS MODEL
// ============================================

// ============================================
// FINANCIAL ACCOUNTS MODELS
// ============================================

// ============================================
// USER SETTINGS MODEL
// ============================================

model UserSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique @map("user_id")
  theme                 String   @default("light")
  language              String   @default("en")
  dateFormat            String   @default("YYYY-MM-DD") @map("date_format")
  timeFormat            String   @default("24h") @map("time_format")
  weekStartDay          String   @default("monday") @map("week_start_day")
  defaultView           String   @default("dashboard") @map("default_view")
  textSize              String   @default("medium") @map("text_size")
  notificationEnabled   Boolean  @default(true) @map("notification_enabled")
  emailNotifications    Boolean  @default(true) @map("email_notifications")
  pushNotifications     Boolean  @default(true) @map("push_notifications")
  budgetAlerts          Boolean  @default(true) @map("budget_alerts")
  subscriptionReminders Boolean  @default(true) @map("subscription_reminders")
  loanReminders         Boolean  @default(true) @map("loan_reminders")
  exportFormat          String   @default("pdf") @map("export_format")
  biometricEnabled      Boolean  @default(false) @map("biometric_enabled")
  autoBackup            Boolean  @default(false) @map("auto_backup")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ============================================
// IMPROVED GROUP EXPENSES (Splitwise-like)
// ============================================

model GroupExpense {
  id           String   @id @default(uuid())
  groupId      String   @map("group_id")
  paidByUserId String?  @map("paid_by_user_id") // Can be null for non-members
  paidByName   String?  @map("paid_by_name") // For non-member payers
  categoryId   String?  @map("category_id")
  amount       Decimal  @db.Decimal(15, 2)
  currency     String   @default("INR")
  description  String
  expenseDate  DateTime @map("expense_date") @db.Date
  notes        String?
  receiptUrl   String?  @map("receipt_url")
  splitType    String   @default("equal") @map("split_type") // 'equal', 'exact', 'percentage'
  isSettled    Boolean  @default(false) @map("is_settled")

  // Validation tracking
  splitValidationStatus String? @default("valid") @map("split_validation_status") // 'valid', 'sum_mismatch', 'percentage_mismatch', 'pending'
  hasAdjustments        Boolean @default(false) @map("has_adjustments")
  adjustmentReason      String? @map("adjustment_reason")

  // Optimistic locking
  version        Int       @default(1)
  lastModifiedBy String?   @map("last_modified_by")
  lastModifiedAt DateTime? @map("last_modified_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  group        Group               @relation(fields: [groupId], references: [id], onDelete: Cascade)
  paidBy       User?               @relation("GroupExpensePaidBy", fields: [paidByUserId], references: [id])
  category     Category?           @relation(fields: [categoryId], references: [id])
  lastModifier User?               @relation("ExpenseLastModifier", fields: [lastModifiedBy], references: [id])
  splits       GroupExpenseSplit[]

  @@index([groupId])
  @@index([paidByUserId])
  @@index([expenseDate])
  @@index([isSettled])
  @@index([categoryId])
  @@index([splitValidationStatus])
  @@index([groupId, expenseDate(sort: Desc)]) // Composite index for paginated expense list
  @@index([groupId, isSettled]) // For filtering settled/unsettled expenses
  @@map("group_expenses")
}

model GroupExpenseSplit {
  id             String    @id @default(uuid())
  groupExpenseId String    @map("group_expense_id")
  userId         String?   @map("user_id") // Can be null for non-members
  memberName     String?   @map("member_name") // For non-member participants
  amountOwed     Decimal   @map("amount_owed") @db.Decimal(15, 2)
  amountPaid     Decimal   @default(0) @map("amount_paid") @db.Decimal(15, 2)
  percentage     Decimal?  @db.Decimal(5, 2) // For percentage splits
  isPaid         Boolean   @default(false) @map("is_paid")
  paidAt         DateTime? @map("paid_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  groupExpense GroupExpense @relation(fields: [groupExpenseId], references: [id], onDelete: Cascade)
  user         User?        @relation("GroupExpenseSplitUser", fields: [userId], references: [id])

  @@unique([groupExpenseId, userId])
  @@index([groupExpenseId])
  @@index([userId])
  @@index([isPaid])
  @@index([groupExpenseId, userId]) // Composite index for split lookups
  @@index([userId, isPaid]) // For user's unpaid splits
  @@map("group_expense_splits")
}

model Settlement {
  id         String   @id @default(uuid())
  groupId    String   @map("group_id")
  fromUserId String   @map("from_user_id")
  toUserId   String   @map("to_user_id")
  amount     Decimal  @db.Decimal(15, 2)
  currency   String   @default("INR")
  settledAt  DateTime @map("settled_at")
  notes      String?

  // Loan tracking
  loanId String? @map("loan_id")

  createdAt DateTime @default(now()) @map("created_at")

  group    Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  fromUser User  @relation("SettlementFrom", fields: [fromUserId], references: [id])
  toUser   User  @relation("SettlementTo", fields: [toUserId], references: [id])
  loan     Loan? @relation(fields: [loanId], references: [id], onDelete: SetNull)

  @@index([groupId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([settledAt])
  @@index([loanId])
  @@map("settlements")
}

// ============================================
// OTP VERIFICATION MODEL
// ============================================

model Otp {
  id          String    @id @default(uuid())
  userId      String?   @map("user_id")
  email       String
  code        String
  purpose     String // 'registration', 'login', 'password_reset'
  expiresAt   DateTime  @map("expires_at")
  isUsed      Boolean   @default(false) @map("is_used")
  usedAt      DateTime? @map("used_at")
  attempts    Int       @default(0)
  maxAttempts Int       @default(5) @map("max_attempts")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, purpose])
  @@index([code])
  @@index([expiresAt])
  @@index([email, createdAt])
  @@map("otps")
}
